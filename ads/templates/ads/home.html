{% extends 'ads/base.html' %}

{% block title %}Все объявления{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Все объявления</h1>

    <div class="mb-3">
        <a href="{% url 'admin_ads' %}" class="btn btn-warning">Объявления админа</a>
    </div>

    <!-- Форма поиска -->
    <form method="get" class="form-inline mb-4">
        <input type="text" name="q" value="{{ search_query }}" placeholder="Поиск..."
               class="form-control mr-2" />
        <select name="category" class="form-control mr-2">
            <option value="">Все категории</option>
            {% for category in categories %}
            <option value="{{ category.slug }}"
                    {% if current_category == category.slug %}selected{% endif %}>
                {{ category.name }}
            </option>
            {% endfor %}
        </select>
        <select name="city" class="form-control mr-2">
            <option value="">Все города</option>
            {% for city in cities %}
            <option value="{{ city.slug }}"
                    {% if current_city == city.slug %}selected{% endif %}>
                {{ city.name }}
            </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Искать</button>
    </form>

    <!-- Сортировка -->
    <div class="mb-3">
        <span>Сортировать по:</span>
        <a href="?sort=-created_at&{{ querystring }}" class="btn btn-link {% if current_sort == '-created_at' %}font-weight-bold{% endif %}">Новизне</a>
        <a href="?sort=price&{{ querystring }}" class="btn btn-link {% if current_sort == 'price' %}font-weight-bold{% endif %}">Цене ↑</a>
        <a href="?sort=-price&{{ querystring }}" class="btn btn-link {% if current_sort == '-price' %}font-weight-bold{% endif %}">Цене ↓</a>
        <a href="?sort=-views&{{ querystring }}" class="btn btn-link {% if current_sort == '-views' %}font-weight-bold{% endif %}">Популярности</a>
    </div>

    <!-- Список объявлений -->
    {% for advertisement in advertisements %}
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">
                <a href="{% url 'advertisement_detail' advertisement.slug %}">
                    {{ advertisement.title }}
                </a>
            </h5>
            <p class="card-text">{{ advertisement.description|truncatechars:200 }}</p>
            <p class="card-text">
                <small class="text-muted">
                    Автор: <a href="{% url 'profile' advertisement.author.username %}">{{ advertisement.author.username }}</a> |
                    {{ advertisement.price }} ₽ |
                    {{ advertisement.city.name }} |
                    Просмотры: {{ advertisement.views }} |
                    {{ advertisement.created_at|date:"d.m.Y H:i" }}
                </small>
            </p>
        </div>
    </div>
    {% empty %}
    <p>Пока нет объявлений.</p>
    {% endfor %}

    <!-- Пагинация -->
    <nav>
        <ul class="pagination">
            {% if advertisements.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ advertisements.previous_page_number }}&{{ querystring }}">Назад</a>
            </li>
            {% endif %}

            {% for num in advertisements.paginator.page_range %}
            {% if advertisements.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > advertisements.number|add:'-3' and num < advertisements.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}&{{ querystring }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if advertisements.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ advertisements.next_page_number }}&{{ querystring }}">Вперёд</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}
